{"version":3,"file":"extension.js","mappings":"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","sources":["webpack://tunnel-forwarding/./src/deferredPromise.ts","webpack://tunnel-forwarding/./src/split.ts","webpack://tunnel-forwarding/external commonjs \"vscode\"","webpack://tunnel-forwarding/external node-commonjs \"child_process\"","webpack://tunnel-forwarding/external node-commonjs \"path\"","webpack://tunnel-forwarding/external node-commonjs \"stream\"","webpack://tunnel-forwarding/webpack/bootstrap","webpack://tunnel-forwarding/./src/extension.ts"],"sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nexport type ValueCallback<T = unknown> = (value: T | Promise<T>) => void;\n\nconst enum DeferredOutcome {\n\tResolved,\n\tRejected\n}\n\n/**\n * Copied from src\\vs\\base\\common\\async.ts\n */\nexport class DeferredPromise<T> {\n\n\tprivate completeCallback!: ValueCallback<T>;\n\tprivate errorCallback!: (err: unknown) => void;\n\tprivate outcome?: { outcome: DeferredOutcome.Rejected; value: any } | { outcome: DeferredOutcome.Resolved; value: T };\n\n\tpublic get isRejected() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Rejected;\n\t}\n\n\tpublic get isResolved() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Resolved;\n\t}\n\n\tpublic get isSettled() {\n\t\treturn !!this.outcome;\n\t}\n\n\tpublic get value() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Resolved ? this.outcome?.value : undefined;\n\t}\n\n\tpublic readonly p: Promise<T>;\n\n\tconstructor() {\n\t\tthis.p = new Promise<T>((c, e) => {\n\t\t\tthis.completeCallback = c;\n\t\t\tthis.errorCallback = e;\n\t\t});\n\t}\n\n\tpublic complete(value: T) {\n\t\treturn new Promise<void>(resolve => {\n\t\t\tthis.completeCallback(value);\n\t\t\tthis.outcome = { outcome: DeferredOutcome.Resolved, value };\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tpublic error(err: unknown) {\n\t\treturn new Promise<void>(resolve => {\n\t\t\tthis.errorCallback(err);\n\t\t\tthis.outcome = { outcome: DeferredOutcome.Rejected, value: err };\n\t\t\tresolve();\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Transform } from 'stream';\n\nexport const splitNewLines = () => new StreamSplitter('\\n'.charCodeAt(0));\n\n/**\n * Copied and simplified from src\\vs\\base\\node\\nodeStreams.ts\n *\n * Exception: does not include the split character in the output.\n */\nexport class StreamSplitter extends Transform {\n\tprivate buffer: Buffer | undefined;\n\n\tconstructor(private readonly splitter: number) {\n\t\tsuper();\n\t}\n\n\toverride _transform(chunk: Buffer, _encoding: string, callback: (error?: Error | null, data?: any) => void): void {\n\t\tif (!this.buffer) {\n\t\t\tthis.buffer = chunk;\n\t\t} else {\n\t\t\tthis.buffer = Buffer.concat([this.buffer, chunk]);\n\t\t}\n\n\t\tlet offset = 0;\n\t\twhile (offset < this.buffer.length) {\n\t\t\tconst index = this.buffer.indexOf(this.splitter, offset);\n\t\t\tif (index === -1) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tthis.push(this.buffer.subarray(offset, index));\n\t\t\toffset = index + 1;\n\t\t}\n\n\t\tthis.buffer = offset === this.buffer.length ? undefined : this.buffer.subarray(offset);\n\t\tcallback();\n\t}\n\n\toverride _flush(callback: (error?: Error | null, data?: any) => void): void {\n\t\tif (this.buffer) {\n\t\t\tthis.push(this.buffer);\n\t\t}\n\n\t\tcallback();\n\t}\n}\n","module.exports = require(\"vscode\");","module.exports = require(\"child_process\");","module.exports = require(\"path\");","module.exports = require(\"stream\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ChildProcessWithoutNullStreams, spawn } from 'child_process';\nimport * as path from 'path';\nimport * as vscode from 'vscode';\nimport { DeferredPromise } from './deferredPromise';\nimport { splitNewLines } from './split';\n\nexport const enum TunnelPrivacyId {\n\tPrivate = 'private',\n\tPublic = 'public',\n}\n\n/**\n * Timeout after the last port forwarding is disposed before we'll tear down\n * the CLI. This is primarily used since privacy changes to port will appear\n * as a dispose+re-create call, and we don't want to have to restart the CLI.\n */\nconst CLEANUP_TIMEOUT = 10_000;\n\nconst cliPath = process.env.VSCODE_FORWARDING_IS_DEV\n\t? path.join(__dirname, '../../../cli/target/debug/code')\n\t: path.join(\n\t\tvscode.env.appRoot,\n\t\tprocess.platform === 'darwin' ? 'bin' : '../../bin',\n\t\tvscode.env.appQuality === 'stable' ? 'code-tunnel' : 'code-tunnel-insiders',\n\t) + (process.platform === 'win32' ? '.exe' : '');\n\nclass Tunnel implements vscode.Tunnel {\n\tprivate readonly disposeEmitter = new vscode.EventEmitter<void>();\n\tpublic readonly onDidDispose = this.disposeEmitter.event;\n\tpublic localAddress!: string;\n\n\tconstructor(\n\t\tpublic readonly remoteAddress: { port: number; host: string },\n\t\tpublic readonly privacy: TunnelPrivacyId,\n\t) { }\n\n\tpublic setPortFormat(formatString: string) {\n\t\tthis.localAddress = formatString.replace('{port}', String(this.remoteAddress.port));\n\t}\n\n\tdispose() {\n\t\tthis.disposeEmitter.fire();\n\t}\n}\n\nconst enum State {\n\tStarting,\n\tActive,\n\tInactive,\n\tError,\n}\n\ntype StateT =\n\t| { state: State.Inactive }\n\t| { state: State.Starting; process: ChildProcessWithoutNullStreams; cleanupTimeout?: NodeJS.Timeout }\n\t| { state: State.Active; portFormat: string; process: ChildProcessWithoutNullStreams; cleanupTimeout?: NodeJS.Timeout }\n\t| { state: State.Error; error: string };\n\nexport async function activate(context: vscode.ExtensionContext) {\n\tif (vscode.env.remoteAuthority) {\n\t\treturn; // forwarding is local-only at the moment\n\t}\n\n\tconst logger = new Logger(vscode.l10n.t('Port Forwarding'));\n\tconst provider = new TunnelProvider(logger, context);\n\n\tcontext.subscriptions.push(\n\t\tvscode.commands.registerCommand('tunnel-forwarding.showLog', () => logger.show()),\n\t\tvscode.commands.registerCommand('tunnel-forwarding.restart', () => provider.restart()),\n\n\t\tprovider.onDidStateChange(s => {\n\t\t\tvscode.commands.executeCommand('setContext', 'tunnelForwardingIsRunning', s.state !== State.Inactive);\n\t\t}),\n\n\t\tawait vscode.workspace.registerTunnelProvider(\n\t\t\tprovider,\n\t\t\t{\n\t\t\t\ttunnelFeatures: {\n\t\t\t\t\televation: false,\n\t\t\t\t\tprivacyOptions: [\n\t\t\t\t\t\t{ themeIcon: 'globe', id: TunnelPrivacyId.Public, label: vscode.l10n.t('Public') },\n\t\t\t\t\t\t{ themeIcon: 'lock', id: TunnelPrivacyId.Private, label: vscode.l10n.t('Private') },\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t},\n\t\t),\n\t);\n}\n\nexport function deactivate() { }\n\nclass Logger {\n\tprivate outputChannel?: vscode.LogOutputChannel;\n\n\tconstructor(private readonly label: string) { }\n\n\tpublic show(): void {\n\t\treturn this.outputChannel?.show();\n\t}\n\n\tpublic clear() {\n\t\tthis.outputChannel?.clear();\n\t}\n\n\tpublic log(\n\t\tlogLevel: 'trace' | 'debug' | 'info' | 'warn' | 'error',\n\t\tmessage: string,\n\t\t...args: unknown[]\n\t) {\n\t\tif (!this.outputChannel) {\n\t\t\tthis.outputChannel = vscode.window.createOutputChannel(this.label, { log: true });\n\t\t\tvscode.commands.executeCommand('setContext', 'tunnelForwardingHasLog', true);\n\t\t}\n\t\tthis.outputChannel[logLevel](message, ...args);\n\t}\n}\n\nconst didWarnPublicKey = 'didWarnPublic';\n\nclass TunnelProvider implements vscode.TunnelProvider {\n\tprivate readonly tunnels = new Set<Tunnel>();\n\tprivate readonly stateChange = new vscode.EventEmitter<StateT>();\n\tprivate _state: StateT = { state: State.Inactive };\n\n\tprivate get state(): StateT {\n\t\treturn this._state;\n\t}\n\n\tprivate set state(state: StateT) {\n\t\tthis._state = state;\n\t\tthis.stateChange.fire(state);\n\t}\n\n\tpublic readonly onDidStateChange = this.stateChange.event;\n\n\tconstructor(private readonly logger: Logger, private readonly context: vscode.ExtensionContext) { }\n\n\t/** @inheritdoc */\n\tpublic async provideTunnel(tunnelOptions: vscode.TunnelOptions): Promise<vscode.Tunnel | undefined> {\n\t\tif (tunnelOptions.privacy === TunnelPrivacyId.Public) {\n\t\t\tif (!(await this.consentPublicPort(tunnelOptions.remoteAddress.port))) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst tunnel = new Tunnel(\n\t\t\ttunnelOptions.remoteAddress,\n\t\t\t(tunnelOptions.privacy as TunnelPrivacyId) || TunnelPrivacyId.Private,\n\t\t);\n\n\t\tthis.tunnels.add(tunnel);\n\t\ttunnel.onDidDispose(() => {\n\t\t\tthis.tunnels.delete(tunnel);\n\t\t\tthis.updateActivePortsIfRunning();\n\t\t});\n\n\t\tswitch (this.state.state) {\n\t\t\tcase State.Error:\n\t\t\tcase State.Inactive:\n\t\t\t\tawait this.setupPortForwardingProcess();\n\t\t\t// fall through since state is now starting\n\t\t\tcase State.Starting:\n\t\t\t\tthis.updateActivePortsIfRunning();\n\t\t\t\treturn new Promise<Tunnel>((resolve, reject) => {\n\t\t\t\t\tconst l = this.stateChange.event(state => {\n\t\t\t\t\t\tif (state.state === State.Active) {\n\t\t\t\t\t\t\ttunnel.setPortFormat(state.portFormat);\n\t\t\t\t\t\t\tl.dispose();\n\t\t\t\t\t\t\tresolve(tunnel);\n\t\t\t\t\t\t} else if (state.state === State.Error) {\n\t\t\t\t\t\t\tl.dispose();\n\t\t\t\t\t\t\treject(new Error(state.error));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\tcase State.Active:\n\t\t\t\ttunnel.setPortFormat(this.state.portFormat);\n\t\t\t\tthis.updateActivePortsIfRunning();\n\t\t\t\treturn tunnel;\n\t\t}\n\t}\n\n\t/** Re/starts the port forwarding system. */\n\tpublic async restart() {\n\t\tthis.killRunningProcess();\n\t\tawait this.setupPortForwardingProcess(); // will show progress\n\t\tthis.updateActivePortsIfRunning();\n\t}\n\n\tprivate async consentPublicPort(portNumber: number) {\n\t\tconst didWarn = this.context.globalState.get(didWarnPublicKey, false);\n\t\tif (didWarn) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst continueOpt = vscode.l10n.t('Continue');\n\t\tconst dontShowAgain = vscode.l10n.t(\"Don't show again\");\n\t\tconst r = await vscode.window.showWarningMessage(\n\t\t\tvscode.l10n.t(\"You're about to create a publicly forwarded port. Anyone on the internet will be able to connect to the service listening on port {0}. You should only proceed if this service is secure and non-sensitive.\", portNumber),\n\t\t\t{ modal: true },\n\t\t\tcontinueOpt,\n\t\t\tdontShowAgain,\n\t\t);\n\t\tif (r === continueOpt) {\n\t\t\t// continue\n\t\t} else if (r === dontShowAgain) {\n\t\t\tawait this.context.globalState.update(didWarnPublicKey, true);\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate isInStateWithProcess(process: ChildProcessWithoutNullStreams) {\n\t\treturn (\n\t\t\t(this.state.state === State.Starting || this.state.state === State.Active) &&\n\t\t\tthis.state.process === process\n\t\t);\n\t}\n\n\tprivate killRunningProcess() {\n\t\tif (this.state.state === State.Starting || this.state.state === State.Active) {\n\t\t\tthis.logger.log('info', '[forwarding] no more ports, stopping forwarding CLI');\n\t\t\tthis.state.process.kill();\n\t\t\tthis.state = { state: State.Inactive };\n\t\t}\n\t}\n\n\tprivate updateActivePortsIfRunning() {\n\t\tif (this.state.state !== State.Starting && this.state.state !== State.Active) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst ports = [...this.tunnels].map(t => ({ number: t.remoteAddress.port, privacy: t.privacy }));\n\t\tthis.state.process.stdin.write(`${JSON.stringify(ports)}\\n`);\n\n\t\tif (ports.length === 0 && !this.state.cleanupTimeout) {\n\t\t\tthis.state.cleanupTimeout = setTimeout(() => this.killRunningProcess(), CLEANUP_TIMEOUT);\n\t\t} else if (ports.length > 0 && this.state.cleanupTimeout) {\n\t\t\tclearTimeout(this.state.cleanupTimeout);\n\t\t\tthis.state.cleanupTimeout = undefined;\n\t\t}\n\t}\n\n\tprivate async setupPortForwardingProcess() {\n\t\tconst session = await vscode.authentication.getSession('github', ['user:email', 'read:org'], {\n\t\t\tcreateIfNone: true,\n\t\t});\n\n\t\tconst args = [\n\t\t\t'--verbose',\n\t\t\t'tunnel',\n\t\t\t'forward-internal',\n\t\t\t'--provider',\n\t\t\t'github',\n\t\t\t'--access-token',\n\t\t\tsession.accessToken,\n\t\t];\n\n\t\tthis.logger.log('info', '[forwarding] starting CLI');\n\t\tconst child = spawn(cliPath, args, { stdio: 'pipe', env: { ...process.env, NO_COLOR: '1' } });\n\t\tthis.state = { state: State.Starting, process: child };\n\n\t\tconst progressP = new DeferredPromise<void>();\n\t\tvscode.window.withProgress(\n\t\t\t{\n\t\t\t\tlocation: vscode.ProgressLocation.Notification,\n\t\t\t\ttitle: vscode.l10n.t({\n\t\t\t\t\tcomment: ['do not change link format [Show Log](command), only change the text \"Show Log\"'],\n\t\t\t\t\tmessage: 'Starting port forwarding system ([Show Log]({0}))',\n\t\t\t\t\targs: ['command:tunnel-forwarding.showLog']\n\t\t\t\t}),\n\t\t\t},\n\t\t\t() => progressP.p,\n\t\t);\n\n\t\tlet lastPortFormat: string | undefined;\n\t\tchild.on('exit', status => {\n\t\t\tconst msg = `[forwarding] exited with code ${status}`;\n\t\t\tthis.logger.log('info', msg);\n\t\t\tprogressP.complete(); // make sure to clear progress on unexpected exit\n\t\t\tif (this.isInStateWithProcess(child)) {\n\t\t\t\tthis.state = { state: State.Error, error: msg };\n\t\t\t}\n\t\t});\n\n\t\tchild.on('error', err => {\n\t\t\tthis.logger.log('error', `[forwarding] ${err}`);\n\t\t\tprogressP.complete(); // make sure to clear progress on unexpected exit\n\t\t\tif (this.isInStateWithProcess(child)) {\n\t\t\t\tthis.state = { state: State.Error, error: String(err) };\n\t\t\t}\n\t\t});\n\n\t\tchild.stdout\n\t\t\t.pipe(splitNewLines())\n\t\t\t.on('data', line => this.logger.log('info', `[forwarding] ${line}`))\n\t\t\t.resume();\n\n\t\tchild.stderr\n\t\t\t.pipe(splitNewLines())\n\t\t\t.on('data', line => {\n\t\t\t\ttry {\n\t\t\t\t\tconst l: { port_format: string } = JSON.parse(line);\n\t\t\t\t\tif (l.port_format && l.port_format !== lastPortFormat) {\n\t\t\t\t\t\tthis.state = {\n\t\t\t\t\t\t\tstate: State.Active,\n\t\t\t\t\t\t\tportFormat: l.port_format, process: child,\n\t\t\t\t\t\t\tcleanupTimeout: 'cleanupTimeout' in this.state ? this.state.cleanupTimeout : undefined,\n\t\t\t\t\t\t};\n\t\t\t\t\t\tprogressP.complete();\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tthis.logger.log('error', `[forwarding] ${line}`);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.resume();\n\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tchild.on('spawn', resolve);\n\t\t\tchild.on('error', reject);\n\t\t});\n\t}\n}\n"],"names":["this","outcome","value","undefined","constructor","p","Promise","c","e","completeCallback","errorCallback","complete","resolve","error","err","splitNewLines","StreamSplitter","charCodeAt","Transform","splitter","super","_transform","chunk","_encoding","callback","buffer","Buffer","concat","offset","length","index","indexOf","push","subarray","_flush","module","exports","require","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","cliPath","process","env","VSCODE_FORWARDING_IS_DEV","path","join","__dirname","vscode","appRoot","platform","appQuality","Tunnel","remoteAddress","privacy","disposeEmitter","EventEmitter","onDidDispose","event","setPortFormat","formatString","localAddress","replace","String","port","dispose","fire","async","context","remoteAuthority","logger","Logger","l10n","t","provider","TunnelProvider","subscriptions","commands","registerCommand","show","restart","onDidStateChange","s","executeCommand","state","workspace","registerTunnelProvider","tunnelFeatures","elevation","privacyOptions","themeIcon","id","label","outputChannel","clear","log","logLevel","message","args","window","createOutputChannel","didWarnPublicKey","_state","stateChange","tunnels","Set","tunnelOptions","consentPublicPort","tunnel","add","delete","updateActivePortsIfRunning","setupPortForwardingProcess","reject","l","portFormat","Error","killRunningProcess","portNumber","globalState","get","continueOpt","dontShowAgain","r","showWarningMessage","modal","update","isInStateWithProcess","kill","ports","map","number","stdin","write","JSON","stringify","cleanupTimeout","clearTimeout","setTimeout","authentication","getSession","createIfNone","accessToken","child","spawn","stdio","NO_COLOR","progressP","DeferredPromise","withProgress","location","ProgressLocation","Notification","title","comment","on","status","msg","stdout","pipe","line","resume","stderr","parse","port_format","lastPortFormat"],"sourceRoot":""}